name: TruffleHog Secret Scanning

on:
  pull_request:

jobs:
  TruffleHog:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install TruffleHog
      run: |
        curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
        
    - name: Run TruffleHog with detailed output
      run: |
        echo "ğŸ” Running TruffleHog to scan for secrets..."
        echo "============================================="
        
        # Run TruffleHog and capture JSON output
        trufflehog git file://. --since-commit=${{ github.event.pull_request.base.ref }} --branch=HEAD --json --no-verification > trufflehog-results.json || true
        
        # Check if any secrets were found
        if [ -s trufflehog-results.json ]; then
          echo ""
          echo "âš ï¸  SECRETS DETECTED! Here are the details:"
          echo "==========================================="
          
          # Parse and display results with location details
          jq -r 'select(.Found == true) | 
            "ğŸ“„ File: " + (.SourceMetadata.Data.Filesystem.file // .SourceMetadata.Data.Git.file // "Unknown") + 
            "\nğŸ“ Line: " + (.SourceMetadata.Data.Filesystem.line // .SourceMetadata.Data.Git.line // "Unknown" | tostring) + 
            "\nğŸ”‘ Detector: " + .DetectorName + 
            "\nğŸ¯ Secret Type: " + (.DetectorType // "Unknown") +
            "\nğŸ”— Commit: " + (.SourceMetadata.Data.Git.commit // "Current")[0:8] +
            "\n" + ("=" * 50) + "\n"' trufflehog-results.json
          
          echo "âŒ Build failed due to detected secrets. Please remove or exclude them."
          exit 1
        else
          echo "âœ… No secrets detected!"
        fi