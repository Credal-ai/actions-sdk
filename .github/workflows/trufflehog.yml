name: TruffleHog Secret Scanning

on:
  pull_request:

jobs:
  TruffleHog:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install TruffleHog
      run: |
        curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
        
    - name: Run TruffleHog with detailed output
      run: |
        echo "ğŸ” Running TruffleHog to scan for secrets..."
        echo "============================================="
        echo "Base commit: ${{ github.event.pull_request.base.ref }}"
        echo "Head commit: ${{ github.sha }}"
        
        # Debug: Show what TruffleHog is scanning
        echo ""
        echo "ğŸ”§ Debug: Running TruffleHog with verbose output..."
        trufflehog git file://. --since-commit=${{ github.event.pull_request.base.ref }} --branch=HEAD --json --no-verification --debug > trufflehog-full-output.json 2>&1 || true
        
        echo ""
        echo "ğŸ“„ Full TruffleHog output:"
        cat trufflehog-full-output.json
        echo ""
        
        # Extract only the actual findings (lines with "Found":true or "Found":false for debugging)
        echo "ğŸ” Looking for findings..."
        grep '"Found"' trufflehog-full-output.json > trufflehog-all-results.json 2>/dev/null || true
        grep '"Found":true' trufflehog-full-output.json > trufflehog-findings.json 2>/dev/null || true
        
        echo "ğŸ“Š All results (including false positives):"
        if [ -s trufflehog-all-results.json ]; then
          cat trufflehog-all-results.json
        else
          echo "No results found at all"
        fi
        
        echo ""
        echo "ğŸ¯ True findings only:"
        if [ -s trufflehog-findings.json ]; then
          cat trufflehog-findings.json
        else
          echo "No true findings"
        fi
        
        # Check if any actual secret findings exist
        if [ -s trufflehog-findings.json ]; then
          echo ""
          echo "âš ï¸  SECRETS DETECTED! Here are the details:"
          echo "==========================================="
          
          # Parse and display each finding with location details
          while IFS= read -r line; do
            echo "$line" | jq -r '
              "ğŸ“„ File: " + (.SourceMetadata.Data.Filesystem.file // .SourceMetadata.Data.Git.file // "Unknown") + 
              "\nğŸ“ Line: " + (.SourceMetadata.Data.Filesystem.line // .SourceMetadata.Data.Git.line // "Unknown" | tostring) + 
              "\nğŸ”‘ Detector: " + .DetectorName + 
              "\nğŸ¯ Secret Type: " + (.DetectorType // "Unknown") +
              "\nğŸ’¾ Raw Secret (first 50 chars): " + (.Raw[0:50] // "Unknown") + "..." +
              "\nğŸ”— Commit: " + (.SourceMetadata.Data.Git.commit // "Current")[0:8] +
              "\n" + ("=" * 50)'
          done < trufflehog-findings.json
          
          echo ""
          echo "âŒ Build failed due to detected secrets. Please remove or exclude them."
          exit 1
        else
          echo "âœ… No secrets detected!"
        fi