name: TruffleHog Secret Scanning

on:
  pull_request:

jobs:
  TruffleHog:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: TruffleHog OSS
      uses: trufflesecurity/trufflehog@v3.89.2
      with:
        path: ./
        base: ${{ github.event.pull_request.base.ref }}
        head: HEAD
        extra_args: --debug --json --no-verification
      continue-on-error: true
      id: trufflehog
    
    - name: Display TruffleHog Results with Location Details
      if: steps.trufflehog.outcome == 'failure'
      run: |
        echo "ğŸ” Re-running TruffleHog with detailed output to show secret locations:"
        echo "================================================================"
        trufflehog git file://. --since-commit=${{ github.event.pull_request.base.ref }} --branch=HEAD --json --no-verification | \
        jq -r 'select(.Found == true) | "ğŸ“„ File: \(.SourceMetadata.Data.Filesystem.file // .SourceMetadata.Data.Git.file // "Unknown")\nğŸ“ Line: \(.SourceMetadata.Data.Filesystem.line // "Unknown")\nğŸ”‘ Type: \(.DetectorName)\nğŸ¯ Secret (preview): \(.Raw[:50])...\nğŸ”— Commit: \(.SourceMetadata.Data.Git.commit // "Current")\n" + ("=" * 60)'